/*!
 * Modified by yswang(wangys0927@gmail.com) at:
 * 2014/12/31 -> 0.8.5 Supported legacy IE(6,7).
 * 2015/01/04 -> 0.8.6 Upgrade route path parser.
 * 2015/01/16 -> 0.9 Use new route path parser, now it's powerful!				  
 */
;(function(b){var a={version:"0.9",map:function(d){var c=a._pathToString(d);if(a.routes.defined.hasOwnProperty(c)){return a.routes.defined[c];}else{return new a.core.route(d);}},root:function(c){a.routes.root=c;},rescue:function(c){a.routes.rescue=c;},history:{initial:{},pushState:function(c,e,d){if(a.history.supported){if(a.dispatch(d)){b.history.pushState(c,e,d);}}else{if(a.history.fallback){b.location.hash="#"+d;}}},popState:function(d){var c=!a.history.initial.popped&&b.location.href==a.history.initial.URL;a.history.initial.popped=true;if(c){return;}a.dispatch(document.location.pathname);},listen:function(c){a.history.supported=!!(b.history&&b.history.pushState);a.history.fallback=c;if(a.history.supported){a.history.initial.popped=("state" in b.history);a.history.initial.URL=b.location.href;b.onpopstate=a.history.popState;}else{if(a.history.fallback){for(route in a.routes.defined){if(route.charAt(0)!="#"){a.routes.defined["#"+route]=a.routes.defined[route];a.routes.defined["#"+route].path="#"+route;}}a.listen();}}}},match:function(e,d){var c=null;for(var f in a.routes.defined){c=a.routes.defined[f];if(c&&c.match(e,d)){return c;}}return null;},dispatch:function(c){var d,e;if(a.routes.current!==c){a.routes.previous=a.routes.current;a.routes.current=c;e=a.match(c,true);if(a.routes.previous){d=a.match(a.routes.previous);if(d!==null&&typeof d.do_exit==="function"){d.do_exit();}}if(e!==null){e.run();return true;}else{if(a.routes.rescue!==null){a.routes.rescue();}}}},listen:function(){a._hackLegacyIE();var c=function(){a.dispatch(b.location.hash);};if(b.location.hash===""){if(a.routes.root!==null){b.location.hash=a.routes.root;}}if("onhashchange" in b&&(!document.documentMode||document.documentMode>=8)){b.onhashchange=c;}else{setInterval(c,50);}if(b.location.hash!==""){a.dispatch(b.location.hash);}},core:{route:function(c){this.path=a._pathToString(c);this.pathKeys=[];this.pathRegExp=a._pathRegExp(c,this.pathKeys,false,false);this.action=null;this.do_enter=[];this.do_exit=null;this.params={};a.routes.defined[a._pathToString(c)]=this;}},routes:{current:null,root:null,rescue:null,previous:null,defined:{}},_pathToString:function(c){if(Object.prototype.toString.call(c)==="[object Array]"){return"["+c.join(",")+"]";}return c.toString();},_pathRegExp:function(s,r,h,n){if(Object.prototype.toString.call(s)==="[object RegExp]"){return s;}if(Object.prototype.toString.call(s)==="[object Array]"){s="("+s.join("|")+")";}var l=[];s=s.concat(n?"":"/?").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(j,u,w,t,c,i,v){l.push({name:t,optional:!!i});u=u||"";return""+(i?"":u)+"(?:"+(i?u:"")+(w||"")+(c||(w&&"([^/.]+?)"||"([^/]+?)"))+")"+(i||"")+(v?"(/*)?":"");}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");if(Object.prototype.toString.call(r)==="[object Array]"&&l.length>0){var m=[],p=[],g=[];for(var e=0,f=s.length;e<f;++e){var k=s.charAt(e),q=s.charAt(e-1)!=="\\";if(k==="("&&q){m.push(k);p.push(k);}else{if(k===")"&&q){m.pop();p.push(k);if(m.length==0){g.push(p.join("").indexOf("?:")!=-1?1:0);p=[];}}else{if(m.length>0){p.push(k);}}}}if(m.length>0){throw new Error("The Path regexp <"+s+"> has unmatched group!");}var o=l.slice(0),k=0;for(var d=0,f=g.length;d<f;++d){r.push((g[d]==1&&k<o.length)?o[k++]:false);}}return new RegExp("^"+s+"$",h?"":"i");},_decode:function(d){try{return decodeURIComponent(d);}catch(c){return d;}},_ieFrame:null,_hackLegacyIE:function(){if(a._ieFrame){return;}var d=(!+"\v1")&&!("onhashchange" in b&&(!document.documentMode||document.documentMode>=8));if(!d){return;}var c=document.createElement("iframe");c.src="about:blank";c.style.display="none";c.setAttribute("tabindex","-1");c.attachEvent("onload",function(){if(a._ieFrame.frameHash&&a._ieFrame.frameHash!=b.location.hash){b.location.hash=a._ieFrame.frameHash;}});document.body.appendChild(c);a._ieFrame=c.contentWindow;c=null;}};a.core.route.prototype={to:function(c){this.action=c;return this;},enter:function(c){if(c instanceof Array){this.do_enter=this.do_enter.concat(c);}else{this.do_enter.push(c);}return this;},exit:function(c){this.do_exit=c;return this;},partition:function(){var f=[],c=[],e=/\(([^}]+?)\)/g,g,d;while(g=e.exec(this.path)){f.push(g[1]);}c.push(this.path.split("(")[0]);for(d=0;d<f.length;d++){c.push(c[c.length-1]+f[d]);}return c;},run:function(){var d=false,e,c,h;if(a.routes.defined[this.path].hasOwnProperty("do_enter")){if(a.routes.defined[this.path].do_enter.length>0){for(e=0;e<a.routes.defined[this.path].do_enter.length;e++){c=a.routes.defined[this.path].do_enter[e].call(this);if(c===false){d=true;break;}}}}if(!d){a.routes.defined[this.path].action();}if(a._ieFrame){var g=b.location.hash;if(g!=a._ieFrame.frameHash){g=g.replace(/"/g,'\\"');var f=a._ieFrame.document;f.open();f.write("<html><head><title>"+document.title+'</title><script type="text/javascript">var frameHash="'+g+'";<\/script></head><body>&nbsp;</body></html>');f.close();}}},match:function(n,k){var e=this.pathRegExp.exec(n);if(!e){return false;}if(k){var l=this.pathKeys,c=l.length,j,d,f=[];for(var g=1,h=e.length;g<h;++g){j=c>=g?l[g-1]:null;d="string"==typeof e[g]?a._decode(e[g]):e[g];if(j&&j.name){f[j.name]=d;}else{f.push(d);}}this.params=f;}return true;}};!this.Path&&(this.Path=a);})(window);