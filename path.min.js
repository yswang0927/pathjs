/*!
 * 山哥(wangys0927@gmail.com) at:
 * 2015/08/25 -> 1.0 See README.md
 * 2015/01/16 -> 0.9 Use new route path parser, now it's powerful!	
 * 2015/01/04 -> 0.8.6 Upgrade route path parser.
 * 2014/12/31 -> 0.8.5 Supported legacy IE(6,7).			  
 */
;(function(a,b){if(typeof define==="function"&&define.amd){define(function(){return(a.Path=b(a));});}else{if(typeof exports!=="undefined"){}else{a.Path=b(a);}}})(typeof window!=="undefined"?window:this,function(b){var a=function(f){return("[object Array]"===Object.prototype.toString.call(f));};var e=function(f){return("function"===typeof f);};var d={version:"1.0",map:function(f){var g=d._pathToString(f);if(d.routes.defined.hasOwnProperty(g)){return d.routes.defined[g];}else{return new d.core.Route(f);}},root:function(f){d.routes.root=d._getHashPath(f);},rescue:function(f){d.routes.rescue=f;},to:function(g){if(!g){return;}g=d._getHashPath(g);if(g==d.routes.current){var f=d.match(d.routes.current);if(!f){return;}e(f.do_exit)&&f.do_exit.call(f);d.routes.current=null;d.routes.previous=null;d.dispatch(g);}else{if(d.history.supported){d.history.pushState({},document.title,g);}else{window.location.hash=d._fillHashPath(g);}}},match:function(h,g){var f=null;for(var i in d.routes.defined){f=d.routes.defined[i];if(f&&f.match(h,g)){return f;}}return null;},dispatch:function(f){if(!f){return;}var g,h;if(d.routes.current!==f){d.routes.previous=d.routes.current;d.routes.current=f;h=d.match(f,true);if(d.routes.previous){g=d.match(d.routes.previous);if(g!==null&&e(g.do_exit)){g.do_exit.call(g);}}if(h!==null){h.run();return true;}else{if(d.routes.rescue!==null){d.routes.rescue();}}}},listen:function(f){f=f||{};if(false===f.hashbang){d.routes.options.hashbang=false;}d._hackLegacyIE();var g=function(){d.dispatch(d._getHashPath());};if(window.location.hash===""){if(d.routes.root!==null){window.location.hash=d._fillHashPath(d.routes.root);}}if("onhashchange" in window&&(!document.documentMode||document.documentMode>=8)){window.onhashchange=g;}else{setInterval(g,50);}if(window.location.hash!==""){d.dispatch(d._getHashPath());}},history:{initial:{},pushState:function(f,h,g){if(d.history.supported){if(d.dispatch(g)){window.history.pushState(f,h,g);}}else{if(d.history.fallback){window.location.hash=d._fillHashPath(g);}}},popState:function(g){var f=!d.history.initial.popped&&window.location.href==d.history.initial.URL;d.history.initial.popped=true;if(f){return;}d.dispatch(document.location.pathname);},listen:function(f){f=f||{};d.history.supported=!!(window.history&&window.history.pushState);d.history.fallback=f.fallback;if(d.history.supported){d.history.initial.popped=("state" in window.history);d.history.initial.URL=window.location.href;window.onpopstate=d.history.popState;}else{if(d.history.fallback){d.listen(f);}}}},core:{Route:function(g){this.path=d._pathToString(g);this.pathKeys=[];this.pathRegExp=[];if(a(g)){for(var f=0;f<g.length;f++){this.pathRegExp.push(d._pathRegExp(g[f],this.pathKeys,false,false));}}else{this.pathRegExp.push(d._pathRegExp(g,this.pathKeys,false,false));}this.do_action=function(){};this.do_enter=[];this.do_exit=function(){};this.params={};d.routes.defined[this.path]=this;}},routes:{current:null,root:null,rescue:null,previous:null,options:{hashbang:true},defined:{}},_getHashPath:function(g){var f=g||window.location.hash;if(f.indexOf("#!")===0){f=f.slice(2);}else{if("#"===f.charAt(0)){f=f.slice(1);}}var h=f.indexOf("?");if(h>=0){f=f.slice(0,h);}return f;},_fillHashPath:function(f){if("#"===f.charAt(0)){return f;}return(d.routes.options.hashbang?"#!":"#")+f;},_pathToString:function(f){if(a(f)){return"["+f.join(",")+"]";}return f.toString();},_pathRegExp:function(u,t,l,p){if(Object.prototype.toString.call(u)==="[object RegExp]"){return u;}if(a(u)){u="("+u.join("|")+")";}var n=[];u=u.concat(p?"":"/?").replace(/(\/)?(\.)?:(\w+)(?:(\(.*?\)))?(\?)?(\*)?/g,function(v,x,z,w,i,j,y){n.push({name:w,optional:!!j});x=x||"";return""+(j?"":x)+"(?:"+(j?x:"")+(z||"")+(i||(z&&"([^/.]+?)"||"([^/]+?)"))+")"+(j||"")+(y?"(/*)?":"");}).replace(/([\/.])/g,"\\$1").replace(/\*/g,"(.*)");if(a(t)&&n.length>0){var o=[],r=[],k=[];for(var g=0,h=u.length;g<h;++g){var m=u.charAt(g),s=(u.charAt(g-1)!=="\\");if(m==="("&&s){o.push(m);r.push(m);}else{if(m===")"&&s){o.pop();r.push(m);if(o.length==0){k.push(r.join("").indexOf("?:")!=-1?1:0);r=[];}}else{if(o.length>0){r.push(m);}}}}if(o.length>0){throw new Error("The Path regexp <"+u+"> has unmatched group!");}var q=n.slice(0),m=0;for(var f=0,h=k.length;f<h;++f){t.push((k[f]==1&&m<q.length)?q[m++]:false);}}return new RegExp("^"+u+"$",l?"":"i");},_decode:function(g){try{return decodeURIComponent(g);}catch(f){return g;}},_ieFrame:null,_hackLegacyIE:function(){if(d._ieFrame){return;}var g=(!+"\v1")&&!("onhashchange" in window&&(!document.documentMode||document.documentMode>=8));if(!g){return;}var f=document.createElement("iframe");f.src="about:blank";f.style.display="none";f.setAttribute("tabindex","-1");f.attachEvent("onload",function(){if(d._ieFrame.frameHash&&d._ieFrame.frameHash!=window.location.hash){window.location.hash=d._ieFrame.frameHash;}});document.body.appendChild(f);d._ieFrame=f.contentWindow;f=null;}};d.core.Route.prototype={to:function(f){this.do_action=f;return this;},enter:function(f){if(f instanceof Array){this.do_enter=this.do_enter.concat(f);}else{this.do_enter.push(f);}return this;},exit:function(f){this.do_exit=f;return this;},run:function(){var f=false,k;if(this.do_enter.length>0){for(var g=0;g<this.do_enter.length;g++){k=this.do_enter[g];if(!k||!e(k)){continue;}if(false===k.call(this)){f=true;break;}}}if(!f&&e(this.do_action)){this.do_action.call(this);}if(d._ieFrame){var j=window.location.hash;if(j!=d._ieFrame.frameHash){j=j.replace(/"/g,'\\"');var h=d._ieFrame.document;h.open();h.write("<html><head><title>"+document.title+'</title><script type="text/javascript">var frameHash="'+j+'";<\/script></head><body>&nbsp;</body></html>');h.close();}}},match:function(q,o){if(this.pathRegExp.length==0){return false;}for(var k=0;k<this.pathRegExp.length;k++){var h=this.pathRegExp[k].exec(q);if(h){if(o){var p=this.pathKeys,f=p.length,n,g,j=[];for(var k=1,l=h.length;k<l;++k){n=f>=k?p[k-1]:null;g="string"==typeof h[k]?d._decode(h[k]):h[k];if(n&&n.name){j[n.name]=g;}else{j.push(g);}}this.params=j;}return true;}}return false;}};var c=b.Path;d.noConflict=function(){b.Path=c;return d;};return d;});